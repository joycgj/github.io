<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>内核模块编写之hello world | 愿你归来时，仍是少年</title><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/5.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.0/grids-responsive-min.css"><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.1.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">内核模块编写之hello world</h1><a id="logo" href="/.">愿你归来时，仍是少年</a><p class="description"></p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">内核模块编写之hello world</h1><div class="post-meta">Jun 30, 2017<span> | </span><span class="category"><a href="/categories/linux/">linux</a></span><script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> Hits</span></span></div><a data-thread-key="2017/06/30/kernel_helloworld/" href="/2017/06/30/kernel_helloworld/#comments" class="ds-thread-count"></a><div class="clear"><div id="toc" class="toc-article"><div class="toc-title">文章目录</div><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#安装Wmware-Fusion"><span class="toc-number">1.</span> <span class="toc-text">安装Wmware Fusion</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#安装Ubuntu"><span class="toc-number">2.</span> <span class="toc-text">安装Ubuntu</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#安装SSH"><span class="toc-number">3.</span> <span class="toc-text">安装SSH</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#内核编程"><span class="toc-number">4.</span> <span class="toc-text">内核编程</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Linux内核模块基本原理"><span class="toc-number">4.1.</span> <span class="toc-text">Linux内核模块基本原理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#内核编程之hello-world"><span class="toc-number">4.2.</span> <span class="toc-text">内核编程之hello world</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#模块参数传递"><span class="toc-number">4.3.</span> <span class="toc-text">模块参数传递</span></a></li></ol></li></ol></div></div><div class="post-content"><p>昨天晚上一个老邻居突然打电话找我，说他儿子有一个计算机方面的问题搞不定，辗转找到我帮忙，之后他儿子加了我微信，细问原来是一些嵌入式的问题，跟内核有关，即用户态应用程序调用内核态的模块，对于一个对内核了解甚少的人，真是一个挑战。随即上网搜索学习，寄希望于能快速学习并把这个问题搞定。先是看了很多编写内核模块的hello world，有了一个初步的概念。下面记录了整个解决的过程。</p>
<h2 id="安装Wmware-Fusion"><a href="#安装Wmware-Fusion" class="headerlink" title="安装Wmware Fusion"></a>安装Wmware Fusion</h2><p>刚开始是在公司的docker上进行hello world的开发，但是发现在编译时，linux的header搞不定，搜索了一圈，没有发现在docker上搞kernel module编译的。遂去问了内核组的同事，说虚拟机可以搞定。</p>
<p>参考文章: <a href="http://www.sdifen.com/vmwarefusion851.html" target="_blank" rel="external">VMware Fusion 8.5.1 Mac破解版</a><br>下载地址: <a href="https://pan.baidu.com/share/link?shareid=1616737190&amp;uk=3355908067" target="_blank" rel="external">VMware Fusion 8.5.1 Mac破解版</a> 密码: q7w9</p>
<p>破解方法：</p>
<ol>
<li>打开dmg镜像，将“MVware Fusion.app”拖入应用程序中；</li>
<li>打开应用程序-实用工具-终端，输入“chmod +x”；</li>
<li>将“KG”文件夹拖到桌面，将其中的”keymaker”拖入到第二步的命令后面，即:“chmod +x keymaker”回车；</li>
<li>直接双击“keymaker”跳出命令窗口，复制其中的序列号到VMware中完成注册；</li>
<li>Have done！</li>
</ol>
<p>系统版本要求: OS X 10.8或更高。</p>
<h2 id="安装Ubuntu"><a href="#安装Ubuntu" class="headerlink" title="安装Ubuntu"></a>安装Ubuntu</h2><p><a href="http://mirrors.aliyun.com/ubuntu-releases/14.04/" target="_blank" rel="external">Ubuntu ISO下载地址</a></p>
<p>阿里提供的镜像，这个网速还挺快。我下载的版本为 ubuntu-14.04.5-desktop-amd64.iso</p>
<p>安装Ubuntu参考文章 <a href="http://blog.csdn.net/jackjia2015/article/details/50757430" target="_blank" rel="external">Mac上用VMware虚拟机安装Ubuntu</a></p>
<h2 id="安装SSH"><a href="#安装SSH" class="headerlink" title="安装SSH"></a>安装SSH</h2><p>安装完Ubuntu之后，在Mac的终端上登录，报错如下：</p>
<p>ssh: connect to host 192.168.192.128 port 22: Connection refused</p>
<p>发现Ubuntu上的SSH Server没有安装<br>参考文章: <a href="http://www.linuxidc.com/Linux/2015-01/112045.htm" target="_blank" rel="external">Ubuntu 安装配置SSH</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">joy@joy-virtual-machine:~$ sudo apt-get install openssh-server</div></pre></td></tr></table></figure>
<p>安装之后，可以SSH登录。</p>
<h2 id="内核编程"><a href="#内核编程" class="headerlink" title="内核编程"></a>内核编程</h2><h3 id="Linux内核模块基本原理"><a href="#Linux内核模块基本原理" class="headerlink" title="Linux内核模块基本原理"></a>Linux内核模块基本原理</h3><p>Linux内核模块(LKM)是一些在启动的操作系统内核需要时可以载入内核执行的代码块，不需要时由操作系统卸载。它们扩展了操作系统内核功能却不需要重新编译内核、启动系统。如果没有内核模块，就不得不反复编译生成操作系统的内核镜像来加入新功能，当附加的功能很多时，还会使内核变得臃肿。一个linux内核模块主要由以下几个部分组成： </p>
<p>(1) 模块加载函数(必须): 当通过insmod或modprobe命令加载内核模块时，模块的加载函数会自动被内核执行，完成本模块相关初始化工作。 </p>
<p>(2) 模块卸载函数(必须): 当通过rmmod命令卸载模块时，模块的卸载函数会自动被内核执行，完成与模块加载函数相反的功能。 </p>
<p>(3) 模块许可证声明(必须): 模块许可证（LICENCE）声明描述内核模块的许可权限，如果不声明LICENCE，模块被加载时将收到内核被污染的警告。大多数情况下，内核模块应遵循GPL兼容许可权。Linux2.6内核模块最常见的是以MODULE_LICENSE(“Dual BSD/GPL”)语句声明模块采用BSD/GPL双LICENSE。 </p>
<p>(4) 模块参数(可选): 模块参数是模块被加载的时候可以被传递给他的值，它本身对应模块内部的全局变量。 </p>
<p>(5) 模块导出符号(可选): 内核模块可以导出符号(symbol,对应于函数或变量)，这样其他模块可以使用本模块中的变量或函数。 </p>
<p>(6) 模块作者等信息声明(可选)。</p>
<p>一个内核模块至少包含两个函数，模块被加载时执行的初始化函数init_module()和模块被卸载时执行的结束函数cleanup_module()。在最新内核稳定版本2.6中，两个函数可以起任意的名字，通过宏module_init()和module_exit()注册调用要编译内核模块，把代码嵌进内核空间，首先要获取内核源代码，且版本必需与当前正在运行的版本一致。</p>
<p><a href="http://blog.csdn.net/sh21_/article/details/60878812" target="_blank" rel="external">参考原文</a></p>
<p>要想扩展Linux内核的功能，可通过如下两种方法：</p>
<ol>
<li>直接修改Linux内核源码，然后自行编译Linux内核源码；</li>
<li>编写Linux内核模块；</li>
</ol>
<p>内核模块的开发效率更高，而且可以在内核运行时动态加载。由于Linux内核模块是动态加载，所以它也叫可加载内核模块，洋文LKM(Loadable Kernel Module)。Linux内核镜像位于/boot目录下，启动时最先加载，LKM总是在内核启动之后加载。</p>
<p>LKM主要用于：设备驱动、文件系统驱动和系统调用。</p>
<p>为什么使用LKM？</p>
<ol>
<li>不用浪费时间频繁编译内核；</li>
<li>保持原始内核不变；</li>
<li>开发、调试更高效；</li>
<li>灵活，没用的模块一条命令即可卸载；</li>
</ol>
<p>注意：LKM是内核空间程序，不是用户空间程序，你可以把它看成是内核的一部分。也就是LKM没有任何保护，一不小心可能就会导致系统崩溃。</p>
<p><a href="http://blog.topspeedsnail.com/archives/10053?utm_source=tuicool&amp;utm_medium=referral" target="_blank" rel="external">参考原文</a></p>
<h3 id="内核编程之hello-world"><a href="#内核编程之hello-world" class="headerlink" title="内核编程之hello world"></a>内核编程之hello world</h3><p>kernel_hello.c</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line">#include &lt;linux/init.h&gt;</div><div class="line">#include &lt;linux/module.h&gt;</div><div class="line">#include &lt;linux/kernel.h&gt;</div><div class="line"></div><div class="line">/* 以下4个宏分别是许可证，作者，模块描述，模块版本 */</div><div class="line">MODULE_LICENSE(&quot;Dual BSD/GPL&quot;);</div><div class="line">MODULE_AUTHOR(&quot;joy&quot;);</div><div class="line">MODULE_DESCRIPTION(&quot;kernel module hello&quot;);</div><div class="line">MODULE_VERSION(&quot;1.0&quot;);</div><div class="line"></div><div class="line">/* 入口函数 */</div><div class="line">static int hello_init(void)</div><div class="line">&#123;</div><div class="line">    printk(KERN_ALERT &quot;hello_init() start\n&quot;);</div><div class="line"></div><div class="line">    return 0;</div><div class="line">&#125;</div><div class="line"></div><div class="line">/* 退出函数 */</div><div class="line">static void hello_exit(void)</div><div class="line">&#123;</div><div class="line">    printk(KERN_ALERT &quot;hello_exit() start\n&quot;);</div><div class="line">&#125;</div><div class="line"></div><div class="line">/* 注册到内核 */</div><div class="line">module_init(hello_init);</div><div class="line">module_exit(hello_exit);</div></pre></td></tr></table></figure>
<p>Makefile</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">KERNAL_DIR ?= /lib/modules/$(shell uname -r)/build</div><div class="line">PWD := $(shell pwd)</div><div class="line"></div><div class="line">obj-m := kernel_hello.o</div><div class="line"></div><div class="line">default:</div><div class="line">	$(MAKE) -C $(KERNAL_DIR) M=$(PWD) modules</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">oy@joy-virtual-machine:~/clang_work/hello_1$ sudo insmod kernel_hello.ko</div><div class="line">[sudo] password for joy:</div><div class="line">joy@joy-virtual-machine:~/clang_work/hello_1$ lsmod | grep hello</div><div class="line">kernel_hello           16384  0</div><div class="line">joy@joy-virtual-machine:~/clang_work/hello_1$ dmesg | tail -1</div><div class="line">[ 5724.733300] hello_init() start</div><div class="line">joy@joy-virtual-machine:~/clang_work/hello_1$ sudo rmmod kernel_hello</div><div class="line">joy@joy-virtual-machine:~/clang_work/hello_1$ dmesg | tail -2</div><div class="line">[ 5724.733300] hello_init() start</div><div class="line">[ 5778.040073] hello_exit() start</div></pre></td></tr></table></figure>
<h3 id="模块参数传递"><a href="#模块参数传递" class="headerlink" title="模块参数传递"></a>模块参数传递</h3><p>未完待续：<a href="http://www.cnblogs.com/yuuyuu/p/5119891.html" target="_blank" rel="external">http://www.cnblogs.com/yuuyuu/p/5119891.html</a></p>
</div><script type="text/javascript" src="/js/share.js?v=0.0.0" async></script><a data-url="http://yoursite.com/2017/06/30/kernel_helloworld/" data-id="cj4k0pjhp0000v4s6hlhypmgv" class="article-share-link">分享到</a><div class="tags"><a href="/tags/linux-kernel/">linux, kernel</a></div><div class="post-nav"><a href="/2017/06/28/configure-make-install/" class="next">自动生成makefile</a></div><div data-thread-key="2017/06/30/kernel_helloworld/" data-title="内核模块编写之hello world" data-url="http://yoursite.com/2017/06/30/kernel_helloworld/" class="ds-share flat"><div class="ds-share-inline"><ul class="ds-share-icons-16"><li data-toggle="ds-share-icons-more"><a href="javascript:void(0);" class="ds-more">分享到：</a></li><li><a href="javascript:void(0);" data-service="weibo" class="ds-weibo">微博</a></li><li><a href="javascript:void(0);" data-service="qzone" class="ds-qzone">QQ空间</a></li><li><a href="javascript:void(0);" data-service="qqt" class="ds-qqt">腾讯微博</a></li><li><a href="javascript:void(0);" data-service="wechat" class="ds-wechat">微信</a></li></ul><div class="ds-share-icons-more"></div></div></div><div data-thread-key="2017/06/30/kernel_helloworld/" data-title="内核模块编写之hello world" data-url="http://yoursite.com/2017/06/30/kernel_helloworld/" data-author-key="1" class="ds-thread"></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank" class="search-form"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="http://yoursite.com"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/docker/">docker</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/hexo/">hexo</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/linux/">linux</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/virtualization/">virtualization</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/web/">web</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/makefile/" style="font-size: 15px;">makefile</a> <a href="/tags/docker-docker-pull-docker-hub-daocloud/" style="font-size: 15px;">docker, docker pull, docker hub, daocloud</a> <a href="/tags/docker-virtualization/" style="font-size: 15px;">docker,virtualization</a> <a href="/tags/docker/" style="font-size: 15px;">docker</a> <a href="/tags/hexo/" style="font-size: 15px;">hexo</a> <a href="/tags/linux-kernel/" style="font-size: 15px;">linux, kernel</a> <a href="/tags/web/" style="font-size: 15px;">web</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最新文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2017/06/30/kernel_helloworld/">内核模块编写之hello world</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/06/28/configure-make-install/">自动生成makefile</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/02/17/comparing-containers-and-virtual-machines/">Comparing containers and virtual machines</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/02/17/docker-tutorials-darkzebra/">Docker Tutorials from Dark Zebra</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/02/16/docker-registry-mirror/">MacOS 配置 Docker 加速器</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/02/16/unp_v1_tcp/">MacOS 配置 Docker 加速器</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/02/16/docker-install/">Install Docker and run hello-world</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/02/04/install-hexo/">在github上使用hexo搭建博客</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/02/04/nice-web/">好网站</a></li></ul></div><div class="widget"><div class="comments-title"><i class="fa fa-comment-o"> 最近评论</i></div><div data-num-items="5" data-show-avatars="0" data-show-time="1" data-show-admin="0" data-excerpt-length="32" data-show-title="1" class="ds-recent-comments"></div></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="http://www.example1.com/" title="site-name1" target="_blank">site-name1</a><ul></ul><a href="http://www.example2.com/" title="site-name2" target="_blank">site-name2</a><ul></ul><a href="http://www.example3.com/" title="site-name3" target="_blank">site-name3</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">© <a href="/." rel="nofollow">愿你归来时，仍是少年.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> chengaojie.</a></div></div></div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="/css/jquery.fancybox.css?v=0.0.0"><script>var duoshuoQuery = {short_name:'kingaragorn'};
(function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0]
        || document.getElementsByTagName('body')[0]).appendChild(ds);
})();
</script><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>