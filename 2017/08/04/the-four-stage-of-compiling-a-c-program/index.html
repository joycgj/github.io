<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>The Four Stages of Compiling a C Program (forward) | 愿你归来时，仍是少年</title><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/5.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.0/grids-responsive-min.css"><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.1.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">The Four Stages of Compiling a C Program (forward)</h1><a id="logo" href="/.">愿你归来时，仍是少年</a><p class="description"></p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">The Four Stages of Compiling a C Program (forward)</h1><div class="post-meta">Aug 4, 2017<span> | </span><span class="category"><a href="/categories/c/">c</a></span><script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> Hits</span></span></div><a data-thread-key="2017/08/04/the-four-stage-of-compiling-a-c-program/" href="/2017/08/04/the-four-stage-of-compiling-a-c-program/#comments" class="ds-thread-count"></a><div class="clear"><div id="toc" class="toc-article"><div class="toc-title">文章目录</div><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#preprocessing"><span class="toc-number">1.</span> <span class="toc-text">preprocessing</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#compilation"><span class="toc-number">2.</span> <span class="toc-text">compilation</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#assembly"><span class="toc-number">3.</span> <span class="toc-text">assembly</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#linking"><span class="toc-number">4.</span> <span class="toc-text">linking</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#reference"><span class="toc-number">5.</span> <span class="toc-text">reference</span></a></li></ol></div></div><div class="post-content"><p>Knowing how compilation works can be very helpful both when writing code and debugging.</p>
<p>Compiling a C program is a multi-stage process. At an overview level, the process can be split into four separate stages: Preprocessing, compilation, assembly, and linking. Traditional C compilers orchestrate this process by invoking other programs to handle each stage.</p>
<p>In this post, I’ll walk through each of the four stages of compiling the following C program:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">/*</div><div class="line"> * &quot;Hello, World!&quot;: A classic.</div><div class="line"> */</div><div class="line"></div><div class="line">#include &lt;stdio.h&gt;</div><div class="line"></div><div class="line">int </div><div class="line">main(void)</div><div class="line">&#123;</div><div class="line">	puts(&quot;Hello, World!&quot;);</div><div class="line">	return 0;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="preprocessing"><a href="#preprocessing" class="headerlink" title="preprocessing"></a>preprocessing</h2><p>The first stage of compilation is called preprocessing. In this stage, lines starting with a # character are interpreted by the preprocessor as preprocessor commands. These commands form a simple macro language with its own syntax and semantics. This language is used to reduce repetition in source code by providing functionality to inline files, define macros and to conditionally omit code.</p>
<p>Before interpreting commands, the preprocessor does some initial processing. This includes joining continued lines (lines ending with a ) and stripping comments.</p>
<p>To print the result of the preprocessing stage, pass the -E option to cc:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">cc -E hello_world.c</div></pre></td></tr></table></figure>
<p>Given the “Hello, World!” example above, the preprocessor will produce the contents of the stdio.h header file joined with the contents of the hello_world.c file, stripped free from its leading comment:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">[lines omitted for brevity]</div><div class="line"></div><div class="line">extern int __vsnprintf_chk (char * restrict, size_t,</div><div class="line">       int, size_t, const char * restrict, va_list);</div><div class="line"># 493 &quot;/usr/include/stdio.h&quot; 2 3 4</div><div class="line"># 2 &quot;hello_world.c&quot; 2</div><div class="line"></div><div class="line">int</div><div class="line">main(void) &#123;</div><div class="line"> puts(&quot;Hello, World!&quot;);</div><div class="line"> return 0;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="compilation"><a href="#compilation" class="headerlink" title="compilation"></a>compilation</h2><p>The second stage of compilation is confusingly enough called compilation. In this stage, the preprocessed code is translated to assembly instructions specific to the target processor architecture. These form an intermediate human readable language.</p>
<p>The existence of this step allows for C code to contain inline assembly instructions and for different assemblers to be used.</p>
<p>Some compilers also supports the use of an integrated assembler, in which the compilation stage generates machine code directly, avoiding the overhead of generating the intermediate assembly instructions and invoking the assembler.</p>
<p>To save the result of the compilation stage, pass the -S option to cc:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">cc -S hello_world.c</div></pre></td></tr></table></figure>
<p>This will create a file named hello_world.s, containing the generated assembly instructions. On Mac OS 10.10.4, where cc is an alias for clang, the following output is generated:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line">   .section    __TEXT,__text,regular,pure_instructions</div><div class="line">    .macosx_version_min 10, 10</div><div class="line">    .globl  _main</div><div class="line">    .align  4, 0x90</div><div class="line">_main:                                  ## @main</div><div class="line">    .cfi_startproc</div><div class="line">## BB#0:</div><div class="line">    pushq   %rbp</div><div class="line">Ltmp0:</div><div class="line">    .cfi_def_cfa_offset 16</div><div class="line">Ltmp1:</div><div class="line">    .cfi_offset %rbp, -16</div><div class="line">    movq    %rsp, %rbp</div><div class="line">Ltmp2:</div><div class="line">    .cfi_def_cfa_register %rbp</div><div class="line">    subq    $16, %rsp</div><div class="line">    leaq    L_.str(%rip), %rdi</div><div class="line">    movl    $0, -4(%rbp)</div><div class="line">    callq   _puts</div><div class="line">    xorl    %ecx, %ecx</div><div class="line">    movl    %eax, -8(%rbp)          ## 4-byte Spill</div><div class="line">    movl    %ecx, %eax</div><div class="line">    addq    $16, %rsp</div><div class="line">    popq    %rbp</div><div class="line">    retq</div><div class="line">    .cfi_endproc</div><div class="line"></div><div class="line">    .section    __TEXT,__cstring,cstring_literals</div><div class="line">L_.str:                                 ## @.str</div><div class="line">    .asciz  &quot;Hello, World!&quot;</div><div class="line"></div><div class="line"></div><div class="line">.subsections_via_symbols</div></pre></td></tr></table></figure>
<h2 id="assembly"><a href="#assembly" class="headerlink" title="assembly"></a>assembly</h2><p>During the assembly stage, an assembler is used to translate the assembly instructions to machine code, or object code. The output consists of actual instructions to be run by the target processor.</p>
<p>To save the result of the assembly stage, pass the -c option to cc:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">cc -c hello_world.c</div></pre></td></tr></table></figure>
<p>Running the above command will create a file named hello_world.o, containing the object code of the program. The contents of this file is in a binary format and can be inspected using hexdump or od by running either one of the following commands:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">hexdump hello_world.o</div><div class="line">od -c hello_world.o</div></pre></td></tr></table></figure>
<h2 id="linking"><a href="#linking" class="headerlink" title="linking"></a>linking</h2><p>The object code generated in the assembly stage is composed of machine instructions that the processor understands but some pieces of the program are out of order or missing. To produce an executable program, the existing pieces have to be rearranged and the missing ones filled in. This process is called linking.</p>
<p>The linker will arrange the pieces of object code so that functions in some pieces can successfully call functions in other pieces. It will also add pieces containing the instructions for library functions used by the program. In the case of the “Hello, World!” program, the linker will add the object code for the puts function.</p>
<p>The result of this stage is the final executable program. When run without options, cc will name this file a.out. To name the file something else, pass the -o option to cc:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">cc -o hello_world hello_world.c</div></pre></td></tr></table></figure>
<h2 id="reference"><a href="#reference" class="headerlink" title="reference"></a>reference</h2><ol>
<li>[origin]<a href="https://www.calleerlandsson.com/the-four-stages-of-compiling-a-c-program/" target="_blank" rel="external">The Four Stages of Compiling a C Program</a></li>
</ol>
</div><script type="text/javascript" src="/js/share.js?v=0.0.0" async></script><a data-url="http://yoursite.com/2017/08/04/the-four-stage-of-compiling-a-c-program/" data-id="cj5xd02ca0000ygs6bmokgxjz" class="article-share-link">分享到</a><div class="tags"><a href="/tags/c/">c</a></div><div class="post-nav"><a href="/2017/06/30/kernel_helloworld/" class="next">内核模块编写之hello world</a></div><div data-thread-key="2017/08/04/the-four-stage-of-compiling-a-c-program/" data-title="The Four Stages of Compiling a C Program (forward)" data-url="http://yoursite.com/2017/08/04/the-four-stage-of-compiling-a-c-program/" class="ds-share flat"><div class="ds-share-inline"><ul class="ds-share-icons-16"><li data-toggle="ds-share-icons-more"><a href="javascript:void(0);" class="ds-more">分享到：</a></li><li><a href="javascript:void(0);" data-service="weibo" class="ds-weibo">微博</a></li><li><a href="javascript:void(0);" data-service="qzone" class="ds-qzone">QQ空间</a></li><li><a href="javascript:void(0);" data-service="qqt" class="ds-qqt">腾讯微博</a></li><li><a href="javascript:void(0);" data-service="wechat" class="ds-wechat">微信</a></li></ul><div class="ds-share-icons-more"></div></div></div><div data-thread-key="2017/08/04/the-four-stage-of-compiling-a-c-program/" data-title="The Four Stages of Compiling a C Program (forward)" data-url="http://yoursite.com/2017/08/04/the-four-stage-of-compiling-a-c-program/" data-author-key="1" class="ds-thread"></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank" class="search-form"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="http://yoursite.com"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/c/">c</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/docker/">docker</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/hexo/">hexo</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/linux/">linux</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/virtualization/">virtualization</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/web/">web</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/makefile/" style="font-size: 15px;">makefile</a> <a href="/tags/docker-docker-pull-docker-hub-daocloud/" style="font-size: 15px;">docker, docker pull, docker hub, daocloud</a> <a href="/tags/docker-virtualization/" style="font-size: 15px;">docker,virtualization</a> <a href="/tags/docker/" style="font-size: 15px;">docker</a> <a href="/tags/hexo/" style="font-size: 15px;">hexo</a> <a href="/tags/linux-kernel/" style="font-size: 15px;">linux, kernel</a> <a href="/tags/web/" style="font-size: 15px;">web</a> <a href="/tags/c/" style="font-size: 15px;">c</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最新文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2017/08/04/the-four-stage-of-compiling-a-c-program/">The Four Stages of Compiling a C Program (forward)</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/06/30/kernel_helloworld/">内核模块编写之hello world</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/06/28/configure-make-install/">自动生成makefile</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/02/17/comparing-containers-and-virtual-machines/">Comparing containers and virtual machines</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/02/17/docker-tutorials-darkzebra/">Docker Tutorials from Dark Zebra</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/02/16/docker-registry-mirror/">MacOS 配置 Docker 加速器</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/02/16/unp_v1_tcp/">MacOS 配置 Docker 加速器</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/02/16/docker-install/">Install Docker and run hello-world</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/02/04/install-hexo/">在github上使用hexo搭建博客</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/02/04/nice-web/">好网站</a></li></ul></div><div class="widget"><div class="comments-title"><i class="fa fa-comment-o"> 最近评论</i></div><div data-num-items="5" data-show-avatars="0" data-show-time="1" data-show-admin="0" data-excerpt-length="32" data-show-title="1" class="ds-recent-comments"></div></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="http://www.example1.com/" title="site-name1" target="_blank">site-name1</a><ul></ul><a href="http://www.example2.com/" title="site-name2" target="_blank">site-name2</a><ul></ul><a href="http://www.example3.com/" title="site-name3" target="_blank">site-name3</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">© <a href="/." rel="nofollow">愿你归来时，仍是少年.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> chengaojie.</a></div></div></div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="/css/jquery.fancybox.css?v=0.0.0"><script>var duoshuoQuery = {short_name:'kingaragorn'};
(function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0]
        || document.getElementsByTagName('body')[0]).appendChild(ds);
})();
</script><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>